---
title: "ExampleFinals"
output: pdf_document
---

```{r}
library('knitr')

library('rmeta')
#knitr::opts_chunk$set(cache=TRUE)
opts_chunk$set(fig.path = "/Users/sarahurbut/Dropbox/PaperEdits/Paper/Figures/") 
```


```{r exampleuk3,echo=F}
source("../Analysis/normfuncs.R")

z.stat=read.table("~/Dropbox/jul3/maxz.txt")
b.stat=read.table("../Data/maxbetahats.txt")
standard.error=b.stat/z.stat


posterior.means=read.table("~/Dropbox/withzero/withzeroposterior.means.txt")[,-1]


posterior.betas=standard.error*posterior.means
pm.beta.norm=het.norm(posterior.betas)

lfsr=read.table("~/Dropbox/withzero/withzerolfsr.txt")[,-1]
covmat=readRDS("~/Dropbox/withzero/covmatwithzero.rds")
abr.names=as.character(read.table("~/gtexresults_matrixash/Data/abbreviate.names.txt")[,2])
mar.var=read.table("~/Dropbox/withzero/withzeromarginal.var.txt")[,-1]
colnames(lfsr)=colnames(mar.var)=colnames(posterior.means)=colnames(z.stat)
source("~/Dropbox/col.func.R")
source("~/Dropbox/newfunc.R")



library(gplots)
library(ggplot2)
error.bar <- function(x, y, upper, lower=upper, length=0.1,...){
   if(length(x) != length(y) | length(y) !=length(lower) | length(lower) != length(upper))
   stop("vectors must be same length")
   arrows(x,y+upper, x, y-lower, angle=90, code=3, length=length, ...)
}


missing.tissues=c(7,8,19,20,24,25,31,34,37)
uk3labels=read.table("../Analysis/uk3rowindices.txt")[,1]

newfunc.2=function(j){
gtex.colors=read.table('../Data/GTExColors.txt', sep = '\t', comment.char = '')[-missing.tissues,2]
gtex.colors=gtex.colors[uk3labels]
pm.beta.norm=pm.beta.norm[,uk3labels]##shufflecolumns
z.shuffle=z.stat[,uk3labels]
b.shuffle=b.stat[,uk3labels]
post.var=mar.var[uk3labels]
post.bshuffle=posterior.betas[,uk3labels]
sem.shuffle=standard.error[,uk3labels]
lfsr=lfsr[,uk3labels]
title=strsplit(rownames(z.stat)[j], "[.]")[[1]][1]



barplot(as.numeric(z.shuffle[j,]),col = as.character(gtex.colors),las=2,main=title,ylim= c(-2,11),names="")

x=as.numeric(post.bshuffle[j,])
bp <- barplot(x, ylim = c(-0.6, 0.6), col = as.character(gtex.colors),las=2,main=title,names="")
text(bp, x, 
  labels = symnum(as.numeric(lfsr[j,]), cutpoints = c(0, 0.05, 1),   symbols = c(".", "")), pos = 3)

par(mfrow=c(1,1))
metaplot(as.numeric(b.shuffle[j,]),as.numeric(sem.shuffle[j,]),xlab = "",ylab="",colors=meta.colors(box=as.character(gtex.colors)),xlim=c(-1,1))
title(title)

par(mfrow=c(1,1))
sd=as.numeric(sem.shuffle[j,])*sqrt(as.numeric(post.var[j,]))##to transform to posterior sd of beta
metaplot(x,sd,xlab = "",ylab="",colors=meta.colors(box=as.character(gtex.colors)),xlim=c(-1,1))
title(title)
}
````

```{r example3,fig.height=5,fig.width=5}

###
three.ex.3=which(rownames(z.stat)=="ENSG00000249898.3_8_6521432_T_C_b37")
newfunc.2(three.ex.3)

whole.blood.spec=which(rowSums(pm.beta.norm[,-44]<0.5)==43&(rowSums(lfsr[,1:44]<0.05)>=40))

```

```{r testisspec}
##
```

Here are examples of uk5



Old example:
```{r oldex5,fig.width=5,fig.height=5}
###
five.ex=which(rownames(z.stat)=="ENSG00000120029.8_10_103924251_G_A_b37")
testes.spec=which(rowSums(pm.beta.norm[,-40]<0.5)==43&(rowSums(lfsr[,1:44]<0.05)>=40))[1:10]

newfunc.2(five.ex)
```
 Lastly, the inclusion of the eQTLBMA lite configurations (in which the SNP has a non-zero effect in only one tissue) coupled with the learned patterns of tissue specificity evident in matrices Uk 5 through 9 serve to allow the preservation of qualitatively specific effects. Here, we show a gene-snp pair demonstrating strong posterior probability from arising from one of the eQTL-bma lite configs. Accordingly we reject the significance of the effect size estimates in all tissues but testes, a pattern consistent with the presence of tissue-specificity described below. Together, these results cement the resolution afforded by methods which can distinguish among tissues in which a QTL is called active, beyond reducing genetic effects to binary ‘on’ or ‘off’ conclusions.


```{r examplebma,echo=FALSE}
# maxz=z.stat
# eqtlbma.confg=t(as.matrix(c(rep(0,43),1)))
# colnames(eqtlbma.confg)=as.matrix(abr.names)
# par(mar=c(8,4.1,4.1,2.1))
# barplot(eqtlbma.confg,main="SingletonConfig",las=2,cex.names=0.5)
# wholebloodtwo=(which(rownames(maxz)=="ENSG00000078114.14_10_21501314_T_C_b37"))
# wholebloodthree=(which(rownames(maxz)=="ENSG00000029364.7_14_69831447_C_A_b37"))
# #wholebloodfour=(which(rownames(maxz)=="ENSG00000156110.9_10_75928933_T_C_b37"))
# wholebloodfour=(which(rownames(maxz)=="ENSG00000017797.7_18_9488704_C_T_b37"))
# newfunc(t = wholebloodtwo)
# newfunc(t = wholebloodthree)
# newfunc(t=wholebloodfour)

```

Good example for whole bllood with decent rpkm across the board:
```{r wholebloodquant,fig.width=5,fig.height=5}
###
wholebloodfour=(which(rownames(z.stat)=="ENSG00000017797.7_18_9488704_C_T_b37"))
newfunc.2(wholebloodfour)

```


```{r exampleuk2,echo=FALSE}
# k=2
# x=covmat[[k]]/max(diag(covmat[[k]]))
#   colnames(x)=colnames(z.stat)
#   rownames(x)=colnames(z.stat)                  
# two.ex.2=which(rownames(z.stat)=="ENSG00000008838.13_17_38189055_A_G_b37")
# two.ex.1=which(rownames(z.stat)=="ENSG00000007341.14_1_113076756_T_C_b37")
# v=svd(x)$v
# rownames(v)=colnames(v)=as.matrix(abr.names)
# par(mar=c(8,4.1,4.1,2.1))
# barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
# newfunc(t=two.ex.1)
```


```{r exampleuk8,echo=FALSE}
# k=8
# x=covmat[[k]]/max(diag(covmat[[k]]))
#   colnames(x)=colnames(z.stat)
#   rownames(x)=colnames(z.stat)                  
# eight.ex.2=which(rownames(z.stat)=="ENSG00000169962.4_1_909238_G_C_b37")
# 
# v=svd(x)$v
# rownames(v)=colnames(v)=as.matrix(abr.names)
# par(mar=c(8,4.1,4.1,2.1))
# barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
# newfunc(t=eight.ex.2)
```




```{r exampleuk4,echo=FALSE}
# k=4
# x=covmat[[k]]/max(diag(covmat[[k]]))
#   colnames(x)=colnames(z.stat)
#   rownames(x)=colnames(z.stat)                  
# four.ex.2=which(rownames(z.stat)=="ENSG00000151287.12_13_103277654_G_A_b37")
# 
# 
# v=svd(x)$v
# rownames(v)=colnames(v)=as.matrix(abr.names)
# par(mar=c(8,4.1,4.1,2.1))
# barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
# newfunc(t=four.ex.2)
```


```{r exampleconstant,echo=FALSE}
# k=54
# x=covmat[[k]]/max(diag(covmat[[k]]))
#   colnames(x)=colnames(z.stat)
#   rownames(x)=colnames(z.stat)                  
# t=which(rownames(z.stat)=="ENSG00000013573.12_12_31228738_G_A_b37")
# t=4903
# v=svd(x)$v
# rownames(v)=colnames(v)=as.matrix(abr.names)
# par(mar=c(8,4.1,4.1,2.1))
# barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
# 
# par(mfrow=c(1,2))
#   name=strsplit(rownames(z.stat)[t], "[.]")[[1]][1]
#   x.max=min(as.numeric(z.stat[t,]),as.numeric(posterior.means[t,]))
#   x.min=max(as.numeric(z.stat[t,]),as.numeric(posterior.means[t,]))
# a=barplot(as.numeric(z.stat[t,]),ylim=c(-15,0))#)#,las=2,cex.names=0.5,names=colnames(z.stat),
# 
# title(main=paste0("Z Statistic"),font.main=1,col.main="blue")
# mtext(paste0(name),col="purple")
# b=barplot(as.numeric(posterior.means[t,]),col=col.func(t,lfsr=lfsr,posterior.means=posterior.means),ylim=c(-15,0),ylab="E(B|Data)/s.j")#,names=colnames(posterior.means))
# title(main=paste0("E(B|Data)/s.j"),font.main=1,col.main="blue")
# mtext(paste0(name),col="purple")

```


To plot the PC:

```{r eigenvecs}
# pi.mash=readRDS("~/gtexresults_matrixash//Data/pisAug13withED.rds")$pihat
# abr.names=read.table("~/gtexresults_matrixash/Data/abbreviate.names.txt")
# #pi.mash=readRDS("~/Dropbox/withzero/piswithzero.rds")$pihat[-1189]
# pi.mat.mash=matrix(data = pi.mash,nrow = 22,ncol =54,byrow = TRUE)
# par(mfrow=c(3,3))
# par(mar=c(4,3,2,1))
# for(i in 2:9){
#   
# v=svd(covmat[[i]])$v
#   colnames(v)=rownames(v)=abr.names[,2]
# max.effect=sign(v[,1][which.max(abs(v[,1]))])
# barplot(max.effect*v[,1],las=2,main=paste0("EigenVector1ofUk=",i),#main=ifelse(i!=5,paste0("EigenVector1ofUk=",i),""),ylab=ifelse(i==5,paste0("EigenVector1ofUk=",i),""),
#         col=i-1,axisnames=ifelse(i==2,TRUE,FALSE),cex.names=ifelse(i==2,0.4,NULL))
# #if(i==5) { mtext(paste0("EigenVector1ofUk=",i))}
# }
# 
# barplot(rep(1,44),main="Consistent Config, mash.lite")
# 
# significantUK=order(colSums(pi.mat.mash),decreasing = T)[1:6]
# 
# par(mfrow=c(1,1))
# #par(mfrow=c(2,3))
# #par(mar=c(4,3,2,1))
# for(i in significantUK){
#   
# v=svd(covmat[[i]])$v
#   colnames(v)=rownames(v)=abr.names[,2]
# max.effect=sign(v[,1][which.max(abs(v[,1]))])
# barplot(max.effect*v[,1],las=2,main=paste0("EigenVector1ofUk=",i,",pihat=",round(colSums(pi.mat.mash)[i],2)),#main=ifelse(i!=5,paste0("EigenVector1ofUk=",i),""),ylab=ifelse(i==5,paste0("EigenVector1ofUk=",i),""),
#         col=i-1,axisnames=ifelse(i==2,TRUE,FALSE),cex.names=ifelse(i==2,0.4,NULL))
# #if(i==5) { mtext(paste0("EigenVector1ofUk=",i))}
# }
# 
# #barplot(rep(1,44),main="Consistent Config, mash.lite")

