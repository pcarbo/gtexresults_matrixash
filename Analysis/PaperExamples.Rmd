---
title: "ExampleFinals"
output: html_document
---

```{r}
library('knitr')
knitr::opts_chunk$set(cache=TRUE)
opts_chunk$set(fig.path = "/Users/sarahurbut/Dropbox/PaperEdits/Paper/Figures/") 
```


```{r exampleuk3,echo=F}
z.stat=read.table("~/Dropbox/jul3/maxz.txt")
posterior.means=read.table("~/Dropbox/Aug12/Aug13withEDposterior.means.txt")[,-1]
#posterior.means=read.table("~/Dropbox/withzero/withzeroposterior.means.txt")[,-1]
lfsr=read.table("~/Dropbox/Aug12/Aug13withEDlfsr.txt")[,-1]
#lfsr.zero=read.table("~/Dropbox/withzero/withzerolfsr.txt")[,-1]
covmat=readRDS("~/Dropbox/Aug12/covmatAug13withED.rds")
abr.names=as.character(read.table("~/gtexresults_matrixash/Data/abbreviate.names.txt")[,2])
newfunc=function(t){
  #par(mfrow=c(1,2))
  name=strsplit(rownames(z.stat)[t], "[.]")[[1]][1]
  x.min=min(as.numeric(z.stat[t,]),as.numeric(posterior.means[t,]))
  x.max=max(as.numeric(z.stat[t,]),as.numeric(posterior.means[t,]))
a=barplot(as.numeric(z.stat[t,]),xlab="Tissue",#,las=2,cex.names=0.5,names=colnames(z.stat),
ylim=c(x.min,x.max))
title(main=paste0("Z Statistic"),font.main=1,col.main="blue")
mtext(paste0(name),col="purple")
b=barplot(as.numeric(posterior.means[t,]),col=col.func(t,lfsr=lfsr,posterior.means=posterior.means),xlab="Tissue",#cex.names=0.5,las=2,
          ylab="E(B|Data)/s.j",ylim=c(x.min,x.max))#,names=colnames(posterior.means))
title(main=paste0("E(B|Data)/s.j"),font.main=1,col.main="blue")
mtext(paste0(name),col="purple")
}

col.func=function(lfsr,posterior.means,j){
  R=ncol(posterior.means)
  lfsr.mat=as.matrix(lfsr)
  col.mat=NULL
  for(r in 1:R){
 if (lfsr.mat[j,r]<=0.05) {
      col.mat[r]="green"
    } else if (lfsr.mat[j,r]<0.5) {
      col.mat[r]="orange"
    } else if (lfsr.mat[j,r]>=0.50) {
      col.mat[r]="red"
    } 
  }
  return(col.mat)
}


library(gplots)
library(ggplot2)

#three.ex.1=which(rownames(z.stat)=="ENSG00000205771.2_15_44721087_T_A_b37")
three.ex.2=which(rownames(z.stat)=="ENSG00000253520.1_5_179052185_C_G_b37")
three.ex.3=which(rownames(z.stat)=="ENSG00000249898.3_8_6521432_T_C_b37")
#three.ex.4=which(rownames(z.stat)=="ENSG00000058404.15_7_44259706_G_A_b37")

    
#weightplot(genename = three.ex.1,max.weight = 3,covmat = covmat)

k=3
x=covmat[[k]]/max(diag(covmat[[k]]))
colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)                  
# heatmap.2(x,Rowv=FALSE,Colv=FALSE,symm=TRUE,dendrogram="none",density="none",trace="none",col=redblue(256),main=paste0("HeatMapofNormalizedUk",k),cexRow=0.5,cexCol=0.5,symkey=T,symbreaks=T)
v=svd(x)$v

rownames(v)=colnames(v)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
#newfunc(three.ex.2)
newfunc(three.ex.3)
```

You can also embed plots, for example:



```{r exampleuk5,echo=FALSE}

k=5
x=covmat[[k]]/max(diag(covmat[[k]]))
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)                  
# heatmap.2(x,Rowv=FALSE,Colv=FALSE,symm=TRUE,dendrogram="none",density="none",trace="none",col=redblue(256),main=paste0("HeatMapofNormalizedUk",k),cexRow=0.5,cexCol=0.5,symkey=T,symbreaks=T)
five.ex=which(rownames(z.stat)=="ENSG00000120029.8_10_103924251_G_A_b37")
nine.ex.2=which(rownames(z.stat)=="ENSG00000059588.5_1_234612995_T_C_b37")
nine.ex.3=which(rownames(z.stat)=="ENSG00000009830.7_14_77776501_T_A_b37")
spec.ex=which(rownames(z.stat)=="ENSG00000131848.5_19_56741808_G_A_b37")
#barplot(diag(x),las=2,main=paste("Prior Variance of Effect Size for Uk",k),cex.names = 0.5)

#newfunc(t=nine.ex.3)

v=svd(x)$v
rownames(v)=colnames(v)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
newfunc(t=five.ex)
```

 Lastly, the inclusion of the eQTLBMA lite configurations (in which the SNP has a non-zero effect in only one tissue) coupled with the learned patterns of tissue specificity evident in matrices Uk : 5 − 9 serve to allow the preservation of qualitatively specific effects. Here, we show a gene-snp pair demonstrating strong posterior probability from arising from one of the eQTL-bma lite configs. Accordingly we reject the significance of the effect size estimates in all tissues but testes, a pattern consistent with the presence of tissue-specificity described below. Together, these results cement the resolution afforded by methods which can distinguish among tissues in which a QTL is called active, beyond reducing genetic effects to binary ‘on’ or ‘off’ conclusions.


```{r examplebma,echo=FALSE}

eqtlbma.confg=t(as.matrix(c(rep(0,43),1)))
colnames(eqtlbma.confg)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(eqtlbma.confg,main="SingletonConfig",las=2,cex.names=0.5)
wholebloodtwo=(which(rownames(maxz)=="ENSG00000078114.14_10_21501314_T_C_b37"))
wholebloodthree=(which(rownames(maxz)=="ENSG00000029364.7_14_69831447_C_A_b37"))
#wholebloodfour=(which(rownames(maxz)=="ENSG00000156110.9_10_75928933_T_C_b37"))
wholebloodfour=(which(rownames(maxz)=="ENSG00000017797.7_18_9488704_C_T_b37"))
newfunc(t = wholebloodtwo)
newfunc(t = wholebloodthree)
newfunc(t=wholebloodfour)
```


```{r exampleuk2,echo=FALSE}
k=2
x=covmat[[k]]/max(diag(covmat[[k]]))
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)                  
two.ex.2=which(rownames(z.stat)=="ENSG00000008838.13_17_38189055_A_G_b37")
two.ex.1=which(rownames(z.stat)=="ENSG00000007341.14_1_113076756_T_C_b37")
v=svd(x)$v
rownames(v)=colnames(v)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
newfunc(t=two.ex.1)
```


```{r exampleuk8,echo=FALSE}
k=8
x=covmat[[k]]/max(diag(covmat[[k]]))
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)                  
eight.ex.2=which(rownames(z.stat)=="ENSG00000169962.4_1_909238_G_C_b37")

v=svd(x)$v
rownames(v)=colnames(v)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
newfunc(t=eight.ex.2)
```




```{r exampleuk4,echo=FALSE}
k=4
x=covmat[[k]]/max(diag(covmat[[k]]))
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)                  
four.ex.2=which(rownames(z.stat)=="ENSG00000151287.12_13_103277654_G_A_b37")


v=svd(x)$v
rownames(v)=colnames(v)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)
newfunc(t=four.ex.2)
```


```{r exampleconstant,echo=FALSE}
k=54
x=covmat[[k]]/max(diag(covmat[[k]]))
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)                  
t=which(rownames(z.stat)=="ENSG00000013573.12_12_31228738_G_A_b37")
t=4903
v=svd(x)$v
rownames(v)=colnames(v)=as.matrix(abr.names)
par(mar=c(8,4.1,4.1,2.1))
barplot(v[,1]*sign(v[which.max(abs(v[,1])),1]),las=2,main=paste("Eigenvector 1 of Uk",k),cex.names = 0.5)

par(mfrow=c(1,2))
  name=strsplit(rownames(z.stat)[t], "[.]")[[1]][1]
  x.max=min(as.numeric(z.stat[t,]),as.numeric(posterior.means[t,]))
  x.min=max(as.numeric(z.stat[t,]),as.numeric(posterior.means[t,]))
a=barplot(as.numeric(z.stat[t,]),ylim=c(-15,0))#)#,las=2,cex.names=0.5,names=colnames(z.stat),

title(main=paste0("Z Statistic"),font.main=1,col.main="blue")
mtext(paste0(name),col="purple")
b=barplot(as.numeric(posterior.means[t,]),col=col.func(t,lfsr=lfsr,posterior.means=posterior.means),ylim=c(-15,0),ylab="E(B|Data)/s.j")#,names=colnames(posterior.means))
title(main=paste0("E(B|Data)/s.j"),font.main=1,col.main="blue")
mtext(paste0(name),col="purple")

```


To plot the PC:

```{r eigenvecs}
pi.mash=readRDS("~/gtexresults_matrixash//Data/pisAug13withED.rds")$pihat
abr.names=read.table("~/gtexresults_matrixash/Data/abbreviate.names.txt")
#pi.mash=readRDS("~/Dropbox/withzero/piswithzero.rds")$pihat[-1189]
pi.mat.mash=matrix(data = pi.mash,nrow = 22,ncol =54,byrow = TRUE)
par(mfrow=c(3,3))
par(mar=c(4,3,2,1))
for(i in 2:9){
  
v=svd(covmat[[i]])$v
  colnames(v)=rownames(v)=abr.names[,2]
max.effect=sign(v[,1][which.max(abs(v[,1]))])
barplot(max.effect*v[,1],las=2,main=paste0("EigenVector1ofUk=",i),#main=ifelse(i!=5,paste0("EigenVector1ofUk=",i),""),ylab=ifelse(i==5,paste0("EigenVector1ofUk=",i),""),
        col=i-1,axisnames=ifelse(i==2,TRUE,FALSE),cex.names=ifelse(i==2,0.4,NULL))
#if(i==5) { mtext(paste0("EigenVector1ofUk=",i))}
}

barplot(rep(1,44),main="Consistent Config, mash.lite")

significantUK=order(colSums(pi.mat.mash),decreasing = T)[1:6]

par(mfrow=c(1,1))
#par(mfrow=c(2,3))
#par(mar=c(4,3,2,1))
for(i in significantUK){
  
v=svd(covmat[[i]])$v
  colnames(v)=rownames(v)=abr.names[,2]
max.effect=sign(v[,1][which.max(abs(v[,1]))])
barplot(max.effect*v[,1],las=2,main=paste0("EigenVector1ofUk=",i,",pihat=",round(colSums(pi.mat.mash)[i],2)),#main=ifelse(i!=5,paste0("EigenVector1ofUk=",i),""),ylab=ifelse(i==5,paste0("EigenVector1ofUk=",i),""),
        col=i-1,axisnames=ifelse(i==2,TRUE,FALSE),cex.names=ifelse(i==2,0.4,NULL))
#if(i==5) { mtext(paste0("EigenVector1ofUk=",i))}
}

#barplot(rep(1,44),main="Consistent Config, mash.lite")

