---
title: "ShowTissueSpecificPatterns"
output: html_document
---

Check to see if the QTLs have expression values that are tissue-specific. Here, I show densities of the normalized effects for susbets of genes, where the normalized effects are defined as:

$$normspec=log.rpkm[tspecgenes,tissueofinterest]/log.rpkm[tspecgenes,othertissues]$$
$$normother=log.rpkm[nontspecgenes,tissueofinterest]/log.rpkm[nontspecgenes,othertissues]$$

You can see that though the extreme values differ, if we plot the density excluding the top and bottom 1% of data, we get very reasonable overlap of distributions.

```{r, cache=TRUE,echo=FALSE}
library('knitr')

opts_chunk$set(fig.path = "/Users/sarahurbut/Dropbox/PaperEdits/Paper/Figures/") 

library('qtlcharts')
data=read.csv("~/Dropbox/AvgExpr.csv",header = T)
rownames(data)=data[,1]
expr.data=data[,-1]
maxz=read.table("../Data/maxz.txt")
qtl.names=sapply(1:length(rownames(maxz)),function(x){unlist(strsplit(rownames(maxz)[x], "[_]"))[[1]]})
expr.sort=expr.data[rownames(expr.data)%in%qtl.names,]

lfsr=read.table("../Data/Aug13withEDlfsr.txt")[,-1]
pmash=read.table("../Data/Aug13withEDposterior.means.txt")[,-1]


colnames(lfsr)=colnames(pmash)=colnames(maxz)
rownames(lfsr)=rownames(pmash)=rownames(maxz)

a=match(qtl.names,rownames(expr.sort))###in order to make sure the gene names are the same in both


expr.sort=expr.sort[a,]


missing.tissues=c(7,8,19,20,24,25,31,34,37)
exp.sort=expr.sort[,-missing.tissues]
colnames(exp.sort)=colnames(maxz)
```

```{r definefunc,echo=FALSE}
plot_tissuespecific = function(tissuename,lfsr,curvedata,title,thresh=0.05,subset=1:44){
  index_tissue=which(colnames(lfsr) %in% tissuename);
  ybar=title
  ##create a matrix showing whether or not lfsr satisfies threshold
  sigmat = lfsr <= thresh;
  sigs=which(rowSums(sigmat[,index_tissue,drop=FALSE])==length(tissuename) & rowSums(sigmat[,-index_tissue,drop=FALSE])==0)
  sigs.it=which(lfsr[sigs,index_tissue]<thresh)
  iplotCurves(curvedata[sigs,subset],chartOpts=list(curves_xlab="Tissue",curves_ylab=ybar))
}  


plot_tissuespecifictwo = function(tissuename,lfsr,curvedata,title,thresh=0.05,subset=1:44,exclude=0.01){
  index_tissue=which(colnames(lfsr) %in% tissuename);
  ybar=title
  ##create a matrix showing whether or not lfsr satisfies threshold
  sigmat = lfsr <= thresh;
  sigs=which(rowSums(sigmat[,index_tissue,drop=FALSE])==length(tissuename) & rowSums(sigmat[,-index_tissue,drop=FALSE])==0)
  #sigs.it=which(lfsr[sigs,index_tissue]<thresh)
  #iplotCurves(curvedata[sigs,subset],chartOpts=list(curves_xlab="Tissue",curves_ylab=ybar))
  #norm=curvedata[sigs,]/curvedata[sigs,index_tissue]
  #boxplot(norm,las=2)
  norm.spec=t(apply(curvedata[sigs,],1,function(x){x[index_tissue]/(x)}))
  norm.other=t(apply(curvedata[-sigs,],1,function(x){x[index_tissue]/(x)}))
  summary(unlist(as.numeric(norm.spec)))
  summary(unlist(as.numeric(norm.other)))
  norm.other=unlist(as.numeric(norm.other))
  norm.spec=unlist(as.numeric(norm.spec))
  upper.quant=quantile(norm.spec, 1-exclude);lower.quant=quantile(norm.spec, exclude);
  upper.quant.other=quantile(norm.other, 1-exclude);lower.quant.other=quantile(norm.other, exclude);
  xmin=min(lower.quant,lower.quant.other)
  xmax=max(upper.quant,upper.quant.other)
plot(density(as.numeric(norm.other[norm.other<upper.quant.other&norm.other>=lower.quant.other])),
     ,#,nclass=1000,freq=F,
     #main=paste0("Non",tissuename,"SpecificGenes"),
     main=tissuename,
     xlim=c(xmin,xmax))
lines(density(as.numeric(norm.spec[norm.spec<upper.quant&norm.spec>=lower.quant])),col="red",main=paste0(tissuename,"SpecificGenes"))
 
#   hist(as.numeric(norm.other[norm.other<upper.quant.other&norm.other>=lower.quant.other]),nclass=1000,freq=F,xlim=c(xmin,xmax))
} 

compare.distribution=function(tissuename,curvedata,lfsr,thresh=0.05){
    index_tissue=which(colnames(lfsr) %in% tissuename);
    sigmat = lfsr <= thresh;
  sigs=which(rowSums(sigmat[,index_tissue,drop=FALSE])==length(tissuename) & rowSums(sigmat[,-index_tissue,drop=FALSE])==0)
  norm.spec=t(apply(curvedata[sigs,],1,function(x){x[index_tissue]/(x)}))##divide special tissue by other tissue effects for numsigxR matrix
  norm.other=t(apply(curvedata[-sigs,],1,function(x){x[index_tissue]/(x)}))

  norm.other=unlist(as.numeric(norm.other))
  norm.spec=unlist(as.numeric(norm.spec))
  quant.mat=cbind(norm.other=quantile(norm.other,seq(0,1,by=0.05)),norm.spec=quantile(norm.spec,seq(0,1,by=0.05)))
 return(quant.mat)
 }
```

Here we compare quantiles and plot data:

Thyroid:
```{r}
compare.distribution(tissuename = "Thyroid",lfsr = lfsr,curvedata = log(exp.sort),thresh = 0.05 )
  
plot_tissuespecifictwo(tissuename = "Thyroid",lfsr = lfsr,curvedata = log(exp.sort),title = "Test",thresh = 0.05 )
```

Testis:



```{r}
compare.distribution(tissuename = "Testis",lfsr = lfsr,curvedata = log(exp.sort),thresh = 0.05)

plot_tissuespecifictwo(tissuename = "Testis",lfsr = lfsr,curvedata = log(exp.sort),title = "Test",thresh = 0.05 )
```

Whole Blood

```{r}
compare.distribution(tissuename = "Whole_Blood",lfsr = lfsr,curvedata = log(exp.sort),thresh = 0.05 )

plot_tissuespecifictwo(tissuename = "Whole_Blood",lfsr = lfsr,curvedata = log(exp.sort),title = "Test",thresh = 0.05)
```

Muscle_Skeletal
```{r}
compare.distribution(tissuename = "Muscle_Skeletal",lfsr = lfsr,curvedata = log(exp.sort),thresh = 0.05 )

plot_tissuespecifictwo(tissuename = "Muscle_Skeletal",lfsr = lfsr,curvedata = log(exp.sort),title = "Test",thresh = 0.05 )
```



