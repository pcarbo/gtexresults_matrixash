

---
title: "Modeling Patterns of Consistency: Different Structure"
output: html_document
---
Patterns of consistency. Let's image the most common covariance matrices, but this time look at interesting structure.

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

```{r}
covmat=readRDS("../Data/covmatAug13withED.rds")
pis=readRDS("../Data/pisAug13withED.rds")$pihat
z.stat=read.table("../Data/maxz.txt")
pi.mat=matrix(pis,ncol=54,byrow=T)

barplot(t(as.matrix(colSums(pi.mat))),names=c((paste0("K",seq(1:54)))),las=2,cex.names=0.5,main="PiHat")
```

We can see that there is lots of loading on the denoised matrices.
```{r}
order(colSums(pi.mat),decreasing = T)
```

We can see that just 5 matrices appear to receive the majority of the prior weight ( `r sum(colSums(pi.mat)[1:5])`) .

```{r important.mats}
(important=order(colSums(pi.mat),decreasing = T)[1:5])
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(gplots)
library(ggplot2)
#install.packages("fields")
library(fields)
for(k in important){
  x=covmat[[k]]
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)

heatmap.2(x/max(diag(covmat[[k]])),symm=TRUE,dendrogram="none",density="none",trace="none",col=redblue(256),main=paste0("HeatMapofNormalizedUk",k),cexRow=0.5,cexCol=0.5,symkey=T,symbreaks=T)

}
 
```
We can see that the first and most important matrix shows highly correlated genetic effects in brain and that the largest effects are correspondingly also seen in brain:

```{r order of importance}
k=3
colnames(z.stat)[order(diag(covmat[[k]]),decreasing = TRUE)][1:10]
barplot(sort(diag(covmat[[k]])/max(diag(covmat[[k]])),decreasing=TRUE),names=colnames(z.stat)[order(diag(covmat[[k]]),decreasing=TRUE)],las=2,col=c(rep("green",11),rep("orange",11),rep("magenta",11),rep("red",11)),main=paste0("PriorEffectSizeUk",k),cex.names = 0.5)
```

I've colored the sizes by those tissues in each quartile.

```{r}
normdag=(diag(covmat[[3]])/max(diag(covmat[[3]])))
quantile(normdag)
name.order=colnames(z.stat)[order(diag(covmat[[3]]),decreasing=T)]
name.order[1:10]

```

While in the second most important U_k, Uk=2, the brains have the smallest prior effect size.

```{r secondimportant}
colnames(z.stat)[order(diag(covmat[[2]]),decreasing = TRUE)][1:10]
k=2
barplot(sort(diag(covmat[[k]])/max(diag(covmat[[k]])),decreasing=TRUE),names=colnames(z.stat)[order(diag(covmat[[2]]),decreasing=TRUE)],las=2,col=c(rep("green",11),rep("orange",11),rep("magenta",11),rep("red",11)),main=paste0("PriorEffectSizeUk",k),cex.names = 0.5)
```

We can see that in all the common matrices, the patterns of correlation among tissue are distinct, but brains seem consistently correalted even though occasionally they may have large or small prior effects, as reflected on the diagonal of the covariance matrix $U_{k}$.

```{r cormats, message=FALSE, warning=FALSE, echo=FALSE}
library(gplots)
library(ggplot2)
#install.packages("fields")
library(fields)
for(k in important){
  x=cov2cor(covmat[[k]])
  colnames(x)=colnames(z.stat)
  rownames(x)=colnames(z.stat)
heatmap.2(x,symm=TRUE,dendrogram="none",density="none",trace="none",col=redblue(256),main=paste0("HeatMapofCov2CorU_k",k),cexRow=0.5,cexCol=0.5,symkey=T,symbreaks=T)
}
 
```

We can see that as expected, for the single rank matrices 5 8 and 4,the effects in one tissue perfectly predict their effect in another tissue, and accordingly the correlation is either -1 or 1. However, the non-single rank matrices that are most important - matrices 3 and 2 - more subtle intermediate levels of correlation of effect are present.


We can segregate the tissues by their relative importance on the diagonal of the top two covariance matrices.
```{r plot tissues by importance on diagonal}
order1=colnames(z.stat)[order(diag(covmat[[3]]),decreasing=TRUE)]
order2=colnames(z.stat)[order(diag(covmat[[2]]),decreasing=TRUE)]


index=rep(0,44)
for(r in 1:length(colnames(z.stat))){tissue=colnames(z.stat)[r];index[r]=which(order1==tissue)}

index2=rep(0,44)
for(r in 1:length(colnames(z.stat))){tissue=colnames(z.stat)[r];index2[r]=which(order2==tissue)}

plot(index,index2,main="Rank of Prior Variance in UK=2 vs Rank of Prior Variance in Uk=3",xlab="Rank in Uk=3",ylab="Rank in Uk=2")
 text(index,index2,colnames(z.stat),cex=0.5)


plot(diag(covmat[[3]])/max(diag(covmat[[3]])),diag(covmat[[2]])/max(diag(covmat[[2]])),main="Prior variance in Uk2 vs Prior Variance in Uk3",xlab="Prior variance in Uk3",ylab="Prior Variance in Uk=2")
text(diag(covmat[[3]])/max(diag(covmat[[3]])),diag(covmat[[2]])/max(diag(covmat[[2]])),colnames(z.stat),cex=0.5)
```

