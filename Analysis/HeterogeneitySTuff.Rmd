---
title: "heterogeneitywithandwithoutbrainformatthew"
output: html_document
---

```{r setup, include=FALSE}
library('knitr')
knitr::opts_chunk$set(cache=TRUE)
opts_chunk$set(fig.path = "/Users/sarahurbut/Dropbox/PaperEdits/Paper/Figures/") 
source("normfuncs.R")
```

##Heterogeneity Analysis

First, we asked in how many tissues is a QTL signficiant. 
```{r,echo=F}
lfsr=read.table("../../Dropbox/Aug12/Aug13withEDlfsr.txt")[,-1]
lfsr[lfsr<0]=0
lfsr.nobrain=read.table("../withoutbrain/nobrainlfsr.txt")[,-1]
lfsr.brain.only=read.table("../../Dropbox/BrainOnly/brainonlylfsr.txt")[,-1]

tissue.names=as.character(read.table("../Data/abbreviate.names.txt")[,2])
colnames(lfsr)==tissue.names
colnames(lfsr.nobrain)=tissue.names[-c(7:16)]
colnames(lfsr.brain.only)=tissue.names[c(7:16)]
```

```{r smileyplotsameanalysis, echo=FALSE}

#par(mar=c(4,4.5,2,1))
#par(oma=c(3,3,3,3) )
thresh=0.05
par(mfrow=c(1,1))
sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
#barplot(table(nsig[nsig>0]),xlab="Number of tissues",main="Number of Tissues Significant")
#hist(nsig[nsig>0],main="Number of Tissues Significant",xlab="NumberofTissues",nclass=45,col="grey",freq=FALSE)#,ylim=c(0,0.6))
hist(nsig[nsig>0],main="Number of Tissues Significant",xlab="NumberofTissues",col="grey",freq=FALSE,breaks=0.5:44.5,xaxt="n")
axis(1, at=seq(1, 44, by=1), labels=c(1:44))
mean(lfsr[nsig>0,]<0.05)
#mtext("AllTissues")
```

Now make plot of lfsr for other groups of tissues and the comparison plot of Number of QTLs significant between Analysis subtype.
```{r, echo=FALSE}
par(mar=c(4,4.5,2,1))
par(oma=c(3,3,3,3) )
par(mfrow=c(1,2))
thresh=0.05

lfsr.nobrain.alltissues=lfsr[,-c(7:16)]
sigmat=(lfsr.nobrain.alltissues<=thresh)
nsig= rowSums(sigmat)
#hist(nsig[nsig>0],main="",xlab="NumberofTissues",nclass=35,col="grey",freq=FALSE)
hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:34.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))
mtext("Nonbrain")
mean(lfsr.nobrain.alltissues[nsig>0,]<0.05)

lfsr.brainonly.alltissues=lfsr[,c(7:16)]
sigmat=(lfsr.brainonly.alltissues<=thresh)
nsig= rowSums(sigmat)
hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 10, by=1), labels=c(1:10))
#barplot(table(nsig[nsig>0]),xlab="Number of tissues",main="")
mean(lfsr.brainonly.alltissues[nsig>0,]<0.05)
mtext("Brains Only")
title("Number of Tissues Significant", outer=TRUE)

##Compare with results of the three Subgroup analyses
par(mar=c(4,4.5,2,1))
par(oma=c(3,3,3,3) )
par(mfrow=c(1,3))

sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:44.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 44, by=1), labels=c(1:44))

#barplot(table(nsig[nsig>0]),xlab="Number of tissues",main="")
mtext("All Tissues")
lfsr.nobrain.alltissues=lfsr[,-c(7:16)]
sigmat=(lfsr.nobrain.alltissues<=thresh)
nsig= rowSums(sigmat)
hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:34.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))

#barplot(table(nsig[nsig>0]),xlab="Number of tissues",main="")
mtext("Excluding Brains")
mean(lfsr.nobrain.alltissues[nsig>0,]<0.05)

lfsr.brainonly.alltissues=lfsr[,c(7:16)]
sigmat=(lfsr.brainonly.alltissues<=thresh)
nsig= rowSums(sigmat)


hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 10, by=1), labels=c(1:10))

#barplot(table(nsig[nsig>0]),xlab="Number of tissues",main="")
mtext("Brains Only")
mean(lfsr.brainonly.alltissues[nsig>0,]<0.05)
title("Number of Tissues Significant, All Tissue", outer=TRUE)

par(mar=c(4,4.5,2,1))
par(oma=c(3,3,3,3) )
par(mfrow=c(1,3))

sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:44.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 44, by=1), labels=c(1:44))
mtext("All Tissues")
mean(lfsr[nsig>0,]<0.05)
sigmat=(lfsr.nobrain<=thresh)
nsig= rowSums(sigmat)
hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:34.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))
mtext("Excluding Brain")

mean(lfsr.nobrain[nsig>0,]<0.05)
sigmat=(lfsr.brain.only<=thresh)
nsig= rowSums(sigmat)

hist(nsig[nsig>0],main="",xlab="NumberofTissues",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 10, by=1), labels=c(1:10))
mtext("Brain Only")
title("Number of Tissues Significant, Subgroup", outer=TRUE)
mean(lfsr.brain.only[nsig>0,]<0.05)

```

```{r}

maxbeta=read.table("../Data/maxbetahats.txt")
maxz=read.table("../Data/maxz.txt")
#standard.error=maxbeta/maxz
standard.error=read.table("../Data/standard.error.txt")
pm.mash=as.matrix(read.table("../../Dropbox/Aug12/Aug13withEDposterior.means.txt")[,-1])

pm.mash.beta=pm.mash*standard.error

pm.mash.nobrain=as.matrix(read.table("../withoutbrain/nobrainposterior.means.txt")[,-1])*standard.error[,-c(7:16)]

pm.mash.brain.only=as.matrix(read.table("../..//Dropbox/BrainOnly//brainonlyposterior.means.txt")[,-1])*standard.error[,c(7:16)]

```

But now, we can ask much more interesting questions.

```{r hindexplot,echo=FALSE,fig.height=5,fig.width=10}

# par(mar=c(4,4.5,2,1))
# par(oma=c(3,3,3,3) )
thresh=0.05
par(mfrow=c(1,1))

sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)

hist((het.func(het.norm(effectsize=pm.mash.beta[nsig>0,]),threshold=0.5)),main="Number of Tissues >50% Max Effect",xlab="NumberofTissues",breaks=0.5:44.5,col="grey",freq=FALSE,ylim=c(0,0.14),xaxt="n")#,ylim=c(0,0.6))

axis(1, at=seq(1, 44, by=1), labels=c(1:44))
###Now we plot all three groups together using the three Subgroup analyses

par(mar=c(4,4.5,2,1))
par(oma=c(3,3,3,3) )
par(mfrow=c(1,3))
hist((het.func(het.norm(effectsize=pm.mash.beta[nsig>0,]),threshold=0.5)),main="",xlab="NumberofTissues",col="grey",freq=FALSE,breaks=0.5:44.5,xaxt="n")
axis(1, at=seq(1, 44, by=1), labels=c(1:44))#,ylim=c(0,0.6))

mtext("All Tissues")


sigmat=(lfsr.nobrain<=thresh)
nsig= rowSums(sigmat)
hist((het.func(het.norm(effectsize=pm.mash.nobrain[nsig>0,]),threshold=0.5)),main="",xlab="NumberofTissues",breaks=0.5:34.5,col="grey",freq=FALSE,xlim=c(1,34),xaxt="n")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))
#,ylim=c(0,0.6))
#barplot(table(het.func(het.norm(effectsize=pm.mash.nobrain[nsig>0,]),threshold=0.5)),main="",xlab="NumberofTissues")#,nclass=40,col="grey",freq=FALSE)#,ylim=c(0,0.6))
mtext("Excluding Brain")



sigmat=(lfsr.brain.only<=thresh)
nsig= rowSums(sigmat)
brain.norm=het.norm(effectsize=pm.mash.brain.only[nsig>0,])
hist(het.func(brain.norm,threshold=0.5),main="",xlab="NumberofTissues",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 10, by=1), labels=c(1:10))
#,ylim=c(0,0.6))
mtext("BrainOnly")

title("Number of Tissues >50% Max Effect,Subgroup", outer=TRUE)

### now make with all tissue effects


par(mar=c(4,4.5,2,1))
par(oma=c(5,4,0,0) + 0.1)
par(mfrow=c(1,3))


sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)

hist((het.func(het.norm(effectsize=pm.mash.beta[nsig>0,]),threshold=0.5)),main="",xlab="",breaks=0.5:44.5,col="grey",freq=FALSE,ylim=c(0,0.6),xaxt="n")
axis(1, at=seq(1, 44, by=1), labels=c(1:44))#,ylim=c(0,0.6))#,ylim=c(0,0.6))
mtext("All Tissues")


sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)

hist((het.func(het.norm(effectsize=pm.mash.beta[nsig>0,-c(7:16)]),threshold=0.5)),main="",xlab="",breaks=0.5:34.5,col="grey",freq=FALSE,ylim=c(0,0.60),xaxt="n")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))#,ylim=c(0,0.6))
mtext("Non-Brain Tissues")

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)


brain.norm=het.norm(effectsize=pm.mash.beta[nsig>0,c(7:16)])
hist(het.func(brain.norm,threshold=0.5),main="",xlab="",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n",ylim=c(0,0.9))
axis(1, at=seq(1, 10, by=1), labels=c(1:10))
mtext("Brain Tissues")

title(xlab="Number of Tissues Shared (by magnitude)", outer=TRUE,line=3,cex.lab=3)



### now make with all tissue effects doing by sign

sign.func=function(normeffectsize){apply(normeffectsize,1,function(x)(sum(x>0)))}
par(mar=c(4,4.5,2,1))
par(oma=c(5,4,0,0) + 0.1)
par(mfrow=c(1,3))



sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)

hist(sign.func(het.norm(effectsize=pm.mash.beta[nsig>0,])),main="",xlab="",breaks=0.5:44.5,col="grey",freq=FALSE,#ylim=c(0,0.4),
     xaxt="n",ylim=c(0,0.6))
axis(1, at=seq(1, 44, by=1), labels=c(1:44))#,ylim=c(0,0.6))
mtext("All Tissues")


sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)

hist((sign.func(het.norm(effectsize=pm.mash.beta[nsig>0,-c(7:16)]))),main="",xlab="",breaks=0.5:34.5,col="grey",freq=FALSE,ylim=c(0,0.6),#ylim=c(0,0.14),
     xaxt="n")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))#,ylim=c(0,0.6))
mtext("Non-Brain Tissues")

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)


brain.norm=het.norm(effectsize=pm.mash.beta[nsig>0,c(7:16)])
hist(sign.func(brain.norm),main="",xlab="",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n",ylim=c(0,0.9))
axis(1, at=seq(1, 10, by=1), labels=c(1:10))
mtext("Brain Tissues")

title(xlab="Number of Tissues Shared (by sign)", outer=TRUE,line=3,cex.lab=3)
```

Generate the 2x1 plot for sharing of magnitudes for this subset:

```{r}
par(mar=c(4,4.5,2,1))
par(oma=c(3,3,3,3) )
par(mfrow=c(1,2))
sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)

hist((het.func(het.norm(effectsize=pm.mash.beta[nsig>0,-c(7:16)]),threshold=0.5)),main="",xlab="NumberofTissues",breaks=0.5:34.5,col="grey",freq=FALSE,xaxt="n")
#,ylim=c(0,0.6))
mtext("Nonbrain")
axis(1, at=seq(1, 34, by=1), labels=c(1:34))

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)


brain.norm=het.norm(effectsize=pm.mash.beta[nsig>0,c(7:16)])
#hist(het.func(brain.norm,threshold=0.5),main="",xlab="NumberofTissues",nclass=12,col="grey",freq=FALSE)#,ylim=c(0,0.6))
#hist(het.func(brain.norm,threshold=0.5),main="",xlab="NumberofTissues",breaks=seq(0,10,by=1),col="grey",freq=FALSE)#,ylim=c(0,0.6))
hist(het.func(brain.norm,threshold=0.5),main="",xlab="NumberofTissues",breaks=0.5:10.5,col="grey",freq=FALSE,xaxt="n")
axis(1, at=seq(1, 10, by=1), labels=c(1:10))#,ylim=c(0,0.6))
#,ylim=c(0,0.6))
mtext("BrainOnly")

title(xlab="Number of Tissues >50% Max Effect, Global", outer=TRUE)
```



```{r generate table}
sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
(signall=mean(het.norm(pm.mash.beta[nsig>0,])>0))


sigmat=(lfsr.nobrain<=thresh)
nsig= rowSums(sigmat)
(signnobrain=mean(het.norm(pm.mash.nobrain[nsig>0,])>0))


sigmat=(lfsr.brain.only<=thresh)
nsig= rowSums(sigmat)
(signbrainonly=mean(het.norm(pm.mash.brain.only[nsig>0,])>0))
# 

##show that results are robust###
sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(signall.nobrain=mean(het.norm(pm.mash.beta[,-c(7:16)])>0))

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(signall.brainonly=mean(het.norm(pm.mash.beta[nsig>0,c(7:16)])>0))

####
sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
(magall=mean(het.norm(pm.mash.beta[nsig>0,])>0.5))
(magall=mean(het.norm(pm.mash.beta[nsig>0,])>0.5&lfsr[nsig>0,]<0.05))

sigmat=(lfsr.nobrain<=thresh)
nsig= rowSums(sigmat)
(magnobrain=mean(het.norm(pm.mash.nobrain[nsig>0,])>0.5))
(magnobrain=mean(het.norm(pm.mash.nobrain[nsig>0,])>0.5&lfsr.nobrain[nsig>0,]<0.05))

sigmat=(lfsr.brain.only<=thresh)
nsig= rowSums(sigmat)
(magbrain=mean(het.norm(pm.mash.brain.only[nsig>0,])>0.5))
(magbrain=mean(het.norm(pm.mash.brain.only[nsig>0,])>0.5&lfsr.brain.only[nsig>0,]<0.05))

##show that results are robust###
sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(magall.excludingbrain=mean(het.norm(pm.mash.beta[nsig>0,-c(7:16)])>0.5))
(magall.excludingbrain=mean(het.norm(pm.mash.beta[nsig>0,-c(7:16)])>0.5&lfsr[nsig>0,-c(7:16)]<0.05))

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(magall.brainonly=mean(het.norm(pm.mash.beta[nsig>0,c(7:16)])>0.5))
(magall.brainonly=mean(het.norm(pm.mash.beta[nsig>0,c(7:16)])>0.5&lfsr[nsig>0,c(7:16)]<0.05))



###let's also ask which significant associations are consistent in size





####
# (gene_cons_all=1-thresh_inconsistent(effect = pm.mash.beta,thresh=0.05,sigs =lfsr)/nrow(pm.mash.beta))
# (gene_cons_nobrain=1-thresh_inconsistent(effect=pm.mash.nobrain,thresh = 0.05,sigs = lfsr.nobrain)/nrow(pm.mash.nobrain))
# (gene_cons_brainonly=1-thresh_inconsistent(effect=pm.mash.brain.only,thresh = 0.05,sigs = lfsr.brain.only)/nrow(pm.mash.brain.only))
# 
# 
# ##show that results are robust###
# (gene_cons_all.excludingbrain=1-thresh_inconsistent(effect = pm.mash.beta[,-c(7:16)],thresh=0.05,sigs =lfsr[,-c(7:16)])/nrow(pm.mash.beta))
# (gene_cons_all.brainonly=1-thresh_inconsistent(effect = pm.mash.beta[,c(7:16)],thresh=0.05,sigs =lfsr[,c(7:16)])/nrow(pm.mash.beta))
```

And plot the heatmaps of shared homogeneity:

```{r sharedhomogeneiety,echo=FALSE,eval=FALSE}



# library(gplots)
# library(ggplot2)
# #install.packages("fields")
# library(fields)
# library("gridGraphics")
# gl=list()
# 
# grab_grob <- function(){
#   grid.echo()
#   grid.grab()
# }
# 
# 
# ifile <- paste0(k,'homogeneity.png')
#     pdf(ifile)
#  

library('gplots')
R=44
a=het.norm(effectsize = pm.mash.beta)##for each gene, normalize by max effect


thresh=0.05
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=tissue.names
for(i in 1:ncol(lfsr)){
  for(j in 1:ncol(lfsr)){
    sig.row=which(a[,i]>0.5)#&lfsr.mash[,i]<thresh)##one of the tissues close to max effect and satisfies lfsr threshold
    sig.col=which(a[,j]>0.5)#&lfsr.mash[,j]<thresh)
    shared.het[i,j]=length(intersect(sig.row,sig.col))/length(union(sig.row,sig.col))
 }

}


heatmap.2(shared.het,density="none",trace="none",dendrogram = "none",col=redblue(256),main="",cexRow=0.5,cexCol=0.5,symm = T)
mtext("All Tissues")



rm(a)
a=het.norm(effectsize = pm.mash.nobrain)##for each gene, normalize by max effect

shared.het.nobrain=matrix(NA,ncol=R-10,nrow=R-10)
colnames(shared.het.nobrain)=rownames(shared.het.nobrain)=tissue.names[-c(7:16)]
for(i in 1:ncol(lfsr.nobrain)){
  for(j in 1:ncol(lfsr.nobrain)){
    sig.row=which(a[,i]>0.5)#&lfsr.mash[,i]<thresh)##one of the tissues close to max effect and satisfies lfsr threshold
    sig.col=which(a[,j]>0.5)#&lfsr.mash[,j]<thresh)
    shared.het.nobrain[i,j]=length(intersect(sig.row,sig.col))/length(union(sig.row,sig.col))
 }

}

heatmap.2(shared.het.nobrain,density="none",trace="none",dendrogram = "none",col=redblue(256),main=paste0("Proportion Shared Homogeneity"),cexRow=0.5,cexCol=0.5,symm = T,key = FALSE)
mtext("Excluding Brain")

rm(a)
a=het.norm(effectsize = pm.mash.brain.only)##for each gene, normalize by max effect

shared.het.brainonly=matrix(NA,ncol=10,nrow=10)
colnames(shared.het.brainonly)=rownames(shared.het.brainonly)=tissue.names[c(7:16)]
for(i in 1:ncol(lfsr.brain.only)){
  for(j in 1:ncol(lfsr.brain.only)){
    sig.row=which(a[,i]>0.5)#&lfsr.mash[,i]<thresh)##one of the tissues close to max effect and satisfies lfsr threshold
    sig.col=which(a[,j]>0.5)#&lfsr.mash[,j]<thresh)
    shared.het.brainonly[i,j]=length(intersect(sig.row,sig.col))/length(union(sig.row,sig.col))
 }

}


heatmap.2(shared.het.brainonly,density="none",trace="none",dendrogram = "none",col=redblue(256),main="",cexRow=0.5,cexCol=0.5,symm = T,key=FALSE)
mtext("Brain Only")
```

Now we can look at effect sizes which are within 2 fold of each other:


```{r fold-diff-by-effect-size}
library(gplots)
library(ggplot2)
library('colorRamps')
sigmat=lfsr<0.05
sigs=rowSums(sigmat)
a=pm.mash.beta[sigs>0,]##subset to ones that are significant in at least one tissue
thresh=0.05
R=ncol(a)
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=tissue.names
for(i in 1:ncol(a)){
  for(j in 1:ncol(a)){
    quotient=abs(a[,i]/a[,j])##divide effect sizes
    

    shared.het[i,j]=mean(quotient>0.5&quotient<2)
 }

}

all.tissue.order=heatmap.2(shared.het,density="none",trace="none",dendrogram = "none",col=blue2green,cexRow=0.5,cexCol=0.5,symm = T,main="QTLs within 2-fold Shared by Tissues",breaks=seq(0.35,1,by=0.01))$rowInd

#write.table(all.tissue.order,"~/Dropbox/alltissueorder.txt",col.names = F,row.names = F)
mtext("All Tissues")


sigmat=lfsr.nobrain<0.05
sigs=rowSums(sigmat)
a=pm.mash.nobrain[sigs>0,]

a=pm.mash.nobrain
R=ncol(a)

thresh=0.05
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=colnames(a)
for(i in 1:ncol(a)){
  for(j in 1:ncol(a)){
    quotient=abs(a[,i]/a[,j])##divide effect sizes
    
  
    shared.het[i,j]=mean(quotient>0.5&quotient<2)
 }

}



excludebrainorder=heatmap.2(shared.het,density="none",trace="none",dendrogram = "none",col=blue2green,cexRow=0.5,cexCol=0.5,symm = T,main="QTLs within 2-fold Shared by Tissues",breaks=seq(0.35,1,by=0.01))$rowInd
mtext("Excluding Brain, Sep Analysis")

#write.table(excludebrainorder,"~/Dropbox/excludebrainorder.txt",col.names = F,row.names = F)

sigmat=lfsr.brain.only<0.05
sigs=rowSums(sigmat)
a=pm.mash.brain.only[sigs>0,]
R=ncol(a)

thresh=0.05
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=colnames(a)
for(i in 1:ncol(a)){
  for(j in 1:ncol(a)){
    quotient=abs(a[,i]/a[,j])##divide effect sizes
    
  
    shared.het[i,j]=mean(quotient>0.5&quotient<2)
 }

}

brain.only.order=heatmap.2(shared.het,density="none",trace="none",dendrogram = "none",col=blue2green,cexRow=0.5,cexCol=0.5,symm = T,main="QTLs within 2-fold Shared by Tissues",breaks=seq(0.35,1,by=0.01))$rowInd
mtext("Brain Only, Sep Analysis")

#write.table(brain.only.order,"~/Dropbox/brain.only.order.txt",col.names = F,row.names = F)
```

Now perform with subset of all tissue effects:

```{r folddiffalltissues}


sigmat=lfsr<0.05
sigs=rowSums(sigmat)
a=pm.mash.beta[sigs>0,]

thresh=0.05
R=ncol(a)
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=tissue.names
for(i in 1:ncol(a)){
  for(j in 1:ncol(a)){
    quotient=abs(a[,i]/a[,j])##divide effect sizes
    

    shared.het[i,j]=mean(quotient>0.5&quotient<2)
 }

}

heatmap.2(shared.het,density="none",trace="none",dendrogram = "none",col=blue2green,cexRow=0.5,cexCol=0.5,symm = T,main="QTLs within 2-fold Shared by Tissues",breaks=seq(0.35,1,by=0.01))
mtext("All Tissues")


sigmat=lfsr[,-c(7:16)]<0.05
sigs=rowSums(sigmat)##subset significant 
a=pm.mash.beta[sigs>0,-c(7:16)]

#a=pm.mash.beta[,-c(7:16)]
R=ncol(a)

thresh=0.05
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=colnames(a)
for(i in 1:ncol(a)){
  for(j in 1:ncol(a)){
    quotient=abs(a[,i]/a[,j])##divide effect sizes
    
  
    shared.het[i,j]=mean(quotient>0.5&quotient<2)
 }

}

heatmap.2(shared.het[rev(excludebrainorder),(excludebrainorder)],density="none",trace="none",dendrogram = "none",col=blue2green,main="",cexRow=0.5,cexCol=0.5,symm = T,Rowv = FALSE,Colv = FALSE,breaks=seq(0.35,1,by=0.01))
mtext("Excluding Brain")


sigmat=lfsr[,c(7:16)]<0.05
sigs=rowSums(sigmat)
a=pm.mash.beta[sigs>0,c(7:16)]
#a=pm.mash.beta[,c(7:16)]
R=ncol(a)

thresh=0.05
shared.het=matrix(NA,ncol=R,nrow=R)
colnames(shared.het)=rownames(shared.het)=colnames(a)
for(i in 1:ncol(a)){
  for(j in 1:ncol(a)){
    quotient=abs(a[,i]/a[,j])##divide effect sizes
    
  
    shared.het[i,j]=mean(quotient>0.5&quotient<2)
 }

}

heatmap.2(shared.het[rev(brain.only.order),brain.only.order],density="none",trace="none",dendrogram = "none",#col=redblue,
          col=blue2green,main="",cexRow=0.5,cexCol=0.5,symm = T,Rowv = FALSE,Colv = FALSE,breaks=seq(0.35,1,by=0.01))
mtext("Brain Only")
```

Let's also consider how our power changes when we perform the Subgroup analyses and when you do it on a per gene basis:

```{r echo=FALSE}

sum(lfsr.brain.only<0.05)
sum(lfsr[,c(7:16)]<0.05)


sum(lfsr.nobrain<0.05)
sum(lfsr[,-c(7:16)]<0.05)


sum(rowSums(lfsr.brain.only<0.05)>0)
sum(rowSums(lfsr[,c(7:16)]<0.05)>0)

sum(rowSums(lfsr.nobrain<0.05)>0)
sum(rowSums(lfsr[,-c(7:16)]<0.05)>0)

```
